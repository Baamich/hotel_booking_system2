{% extends "base.html" %}

{% block title %}{{ hotel.name }} - {{ gettext('details', lang) }}{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-8">
        <h2>{{ hotel.name }}</h2>
        <p><strong>{{ gettext('description', lang) }}:</strong> {{ hotel.description }}</p>
        <hr class="border-dark my-4">
        <p class="price-per-night" data-price-usd="{{ hotel.price_usd }}"><strong>{{ gettext('per_night', lang) }} {{ hotel.display_price }} {{ currency_symbol }}</strong></p>
        
        <!-- ==================== ФОТО ОТЕЛЯ ==================== -->
        <h4>{{ gettext('photos', lang) }}</h4>

        {% if hotel.photos and hotel.photos|length > 0 %}
            <div class="row hotel-photos-gallery">
                {% for photo in hotel.photos %}
                    <div class="col-6 col-md-4 mb-3">
                        <img src="data:image/jpeg;base64,{{ photo }}"
                             class="img-fluid rounded hotel-photo-thumb"
                             style="height: 180px; width: 100%; object-fit: cover; cursor: pointer;"
                             data-photo-index="{{ loop.index0 }}"
                             alt="{{ hotel.name }} photo">
                    </div>
                {% endfor %}
            </div>
        {% else %}
            <p>{{ gettext('no_photos', lang) }}</p>
        {% endif %}

        <!-- ==================== КАРТА ==================== -->
        <h4>{{ gettext('map', lang) }}</h4>
        {% if hotel.latitude and hotel.longitude %}
            <iframe width="100%" height="400" frameborder="0" style="border:0"
                    src="https://www.google.com/maps/embed/v1/place?key={{ config.GOOGLE_MAPS_API_KEY }}&q={{ hotel.latitude }},{{ hotel.longitude }}"
                    allowfullscreen></iframe>
        {% elif hotel.location_address %}
            <iframe width="100%" height="400" frameborder="0" style="border:0"
                    src="https://www.google.com/maps/embed/v1/place?key={{ config.GOOGLE_MAPS_API_KEY }}&q={{ hotel.location_address|urlencode }}"
                    allowfullscreen></iframe>
        {% else %}
            <iframe width="100%" height="400" frameborder="0" style="border:0"
                    src="https://www.google.com/maps/embed/v1/place?key={{ config.GOOGLE_MAPS_API_KEY }}&q={{ hotel.city }}"
                    allowfullscreen></iframe>
        {% endif %}

        <!-- ==================== ДОБАВИТЬ ОТЗЫВ ==================== -->
        <h4>{{ gettext('add_review', lang) }}</h4>
        {% if 'user_id' in session %}
            <form method="POST" action="{{ url_for('search.add_review', hotel_id=hotel._id) }}" enctype="multipart/form-data">
                <select name="rating" class="form-control mb-1">
                    <option value="1">1 {{ gettext('stars', lang) }}</option>
                    <option value="2">2 {{ gettext('stars', lang) }}</option>
                    <option value="3">3 {{ gettext('stars', lang) }}</option>
                    <option value="4">4 {{ gettext('stars', lang) }}</option>
                    <option value="5" selected>5 {{ gettext('stars', lang) }}</option>
                </select>
                <textarea name="text" class="form-control mb-1" placeholder="{{ gettext('add_review', lang) }}" rows="2"></textarea>
                <input type="file" name="photo" multiple class="form-control mb-1">
                <button type="submit" class="btn btn-primary">{{ gettext('add_review', lang) }}</button>
            </form>
        {% else %}
            <p>{{ gettext('login_to_review', lang) }}</p>
        {% endif %}
        
        <!-- ==================== ОТЗЫВЫ ==================== -->
        <h4>{{ gettext('reviews', lang) }}</h4>
        <ul class="list-group">
            {% set visible_reviews = hotel.reviews[:3] %}
            {% for review in visible_reviews %}
                <li class="list-group-item">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <strong>{{ review.user }}</strong>
                            {% if review.source == 'google' %}
                                <span class="badge bg-secondary ms-2">{{ gettext('imported_from_google', lang) }}</span>
                            {% endif %}
                            <span class="text-muted small ms-2">{{ review.date|default("") }}</span>
                        </div>
                        <div class="text-warning">
                            {% for i in range(review.rating|int) %}
                                <i class="bi bi-star-fill"></i>
                            {% endfor %}
                            {% for i in range(5 - (review.rating|int)) %}
                                <i class="bi bi-star"></i>
                            {% endfor %}
                            <span class="ms-2 small">{{ review.rating }}/5</span>
                        </div>
                    </div>

                    <div class="mt-2">
                        <p class="mb-1">{{ review.text }}</p>

                        {% if review.photos and review.photos|length > 0 %}
                            <div class="row mt-2">
                                {% for p in review.photos %}
                                    <div class="col-6 col-md-4 mb-2">
                                        <img src="data:image/jpeg;base64,{{ p }}"
                                             class="img-fluid rounded review-photo-thumb"
                                             style="height: 100px; width: 100%; object-fit: cover; cursor: pointer;"
                                             data-photo-index="{{ loop.index0 }}"
                                             data-photos='{{ review.photos|tojson }}'
                                             alt="Review photo">
                                    </div>
                                {% endfor %}
                            </div>
                        {% endif %}
                    </div>
                </li>
            {% endfor %}

            {% if hotel.reviews|length > 3 %}
                <li class="list-group-item">
                    <button onclick="toggleAllReviews()" class="btn btn-outline-primary btn-sm">
                        {{ gettext('show_all_reviews', lang) }}
                    </button>

                    <div id="hidden-reviews" style="display:none;" class="mt-3">
                        {% for review in hotel.reviews[3:] %}
                            <div class="border p-3 mb-2 rounded">
                                <div class="d-flex justify-content-between align-items-start">
                                    <div>
                                        <strong>{{ review.user }}</strong>
                                        {% if review.source == 'google' %}
                                            <span class="badge bg-secondary ms-2">{{ gettext('imported_from_google', lang) }}</span>
                                        {% endif %}
                                        <span class="text-muted small ms-2">{{ review.date|default("") }}</span>
                                    </div>
                                    <div class="text-warning">
                                        {% for i in range(review.rating|int) %}
                                            <i class="bi bi-star-fill"></i>
                                        {% endfor %}
                                        {% for i in range(5 - (review.rating|int)) %}
                                            <i class="bi bi-star"></i>
                                        {% endfor %}
                                        <span class="ms-2 small">{{ review.rating }}/5</span>
                                    </div>
                                </div>

                                <p class="mt-2 mb-1">{{ review.text }}</p>

                                {% if review.photos and review.photos|length > 0 %}
                                    <div class="row mt-2">
                                        {% for p in review.photos %}
                                            <div class="col-6 col-md-4 mb-2">
                                                <img src="data:image/jpeg;base64,{{ p }}"
                                                     class="img-fluid rounded review-photo-thumb"
                                                     style="height: 100px; width: 100%; object-fit: cover; cursor: pointer;"
                                                     data-photo-index="{{ loop.index0 }}"
                                                     data-photos='{{ review.photos|tojson }}'
                                                     alt="Review photo">
                                            </div>
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                        {% endfor %}
                    </div>
                </li>
            {% endif %}
        </ul>
    </div>

    <!-- ==================== КОМПАКТНАЯ КАРТОЧКА БРОНИРОВАНИЯ (ПРИЛИПАЕТ К ВЕРХУ) ==================== -->
    <div class="col-md-4">
        <div class="sticky-top" style="top: 20px; z-index: 100;">
            {% if 'user_id' in session %}
                <div class="card border-0 shadow-lg rounded-4 overflow-hidden">
                    <div class="card-header bg-primary text-white text-center py-3">
                        <h5 class="mb-0 fw-bold">{{ gettext('book_room', lang)|default('Забронировать') }}</h5>
                        <small class="opacity-90">{{ hotel.display_price }} {{ currency_symbol }} / ночь</small>
                    </div>
                    <div class="card-body p-4">
                        <form id="booking-form">
                            <div class="mb-3">
                                <label class="form-label small fw-semibold">{{ gettext('date_from', lang) }}</label>
                                <input type="date" id="date_from" required class="form-control form-control-sm">
                            </div>
                            <div class="mb-3">
                                <label class="form-label small fw-semibold">{{ gettext('date_to', lang) }}</label>
                                <input type="date" id="date_to" required class="form-control form-control-sm">
                            </div>
                            <div class="mb-3">
                                <label class="form-label small fw-semibold">{{ gettext('first_name', lang)|default('Имя') }}</label>
                                <input type="text" id="first_name" required class="form-control form-control-sm" placeholder="Иван">
                            </div>
                            <div class="mb-3">
                                <label class="form-label small fw-semibold">{{ gettext('last_name', lang)|default('Фамилия') }}</label>
                                <input type="text" id="last_name" required class="form-control form-control-sm" placeholder="Иванов">
                            </div>
                            <div class="mb-3">
                                <label class="form-label small fw-semibold">{{ gettext('phone', lang)|default('Телефон') }}</label>
                                <input type="tel" id="phone" required class="form-control form-control-sm" placeholder="+373 __ ___ ___">
                            </div>
                            <div class="mb-3">
                                <label class="form-label small fw-semibold">{{ gettext('email', lang)|default('Email') }}</label>
                                <input type="email" id="guest_email" required class="form-control form-control-sm" value="{{ session.get('email', '') }}">
                            </div>
                            <div id="total-price" class="alert alert-success text-center fw-bold py-2 mb-3 d-none"></div>
                            <button type="submit" class="btn btn-success w-100 fw-bold py-3 rounded-3">
                                {{ gettext('proceed_to_payment', lang)|default('Оплатить бронь') }}
                            </button>
                        </form>
                    </div>
                </div>
            {% else %}
                <div class="card border-info shadow">
                    <div class="card-body text-center p-4">
                        <p class="mb-3">{{ gettext('login_to_book', lang)|default('Войдите, чтобы забронировать') }}</p>
                        <a href="{{ url_for('auth.login') }}" class="btn btn-primary w-100">Войти</a>
                    </div>
                </div>
            {% endif %}

            <a href="{{ url_for('search.search_hotels') }}" class="btn btn-outline-secondary mt-3 w-100">Назад к поиску</a>
        </div>
    </div>
</div>

<!-- ==================== LIGHTBOX ==================== -->
<div id="photo-lightbox" class="lightbox">
    <span class="close">×</span>
    <div class="lightbox-content">
        <div class="lightbox-main">
            <button class="nav-btn prev">Previous</button>
            <img id="lightbox-img" src="" alt="">
            <button class="nav-btn next">Next</button>
        </div>
        <div id="lightbox-thumbs" class="lightbox-thumbs"></div>
    </div>
</div>

<!-- ==================== JS ==================== -->
<script>
    window.currentHotelPhotos = {{ hotel.photos|tojson }};

    document.querySelectorAll('.hotel-photo-thumb').forEach(img => {
        img.addEventListener('click', function () {
            const index = parseInt(this.dataset.photoIndex);
            openLightbox(window.currentHotelPhotos, index);
        });
    });

    document.querySelectorAll('.review-photo-thumb').forEach(img => {
        img.addEventListener('click', function () {
            const photos = JSON.parse(this.dataset.photos);
            const index = parseInt(this.dataset.photoIndex);
            openLightbox(photos, index);
        });
    });

    function openLightbox(photos, startIndex) {
        const lightbox = document.getElementById('photo-lightbox');
        const mainImg = document.getElementById('lightbox-img');
        const thumbsContainer = document.getElementById('lightbox-thumbs');
        let currentIndex = startIndex;

        thumbsContainer.innerHTML = '';
        photos.forEach((photo, i) => {
            const thumb = document.createElement('img');
            thumb.src = `data:image/jpeg;base64,${photo}`;
            thumb.className = 'thumb';
            if (i === currentIndex) thumb.classList.add('active');
            thumb.addEventListener('click', () => {
                currentIndex = i;
                updateMainImage();
            });
            thumbsContainer.appendChild(thumb);
        });

        function updateMainImage() {
            mainImg.src = `data:image/jpeg;base64,${photos[currentIndex]}`;
            document.querySelectorAll('.thumb').forEach((t, i) => {
                t.classList.toggle('active', i === currentIndex);
            });
        }

        updateMainImage();

        document.querySelector('.prev').onclick = () => {
            currentIndex = (currentIndex - 1 + photos.length) % photos.length;
            updateMainImage();
        };
        document.querySelector('.next').onclick = () => {
            currentIndex = (currentIndex + 1) % photos.length;
            updateMainImage();
        };

        let thumbsVisible = true;
        mainImg.onclick = () => {
            thumbsVisible = !thumbsVisible;
            thumbsContainer.style.display = thumbsVisible ? 'flex' : 'none';
        };

        lightbox.style.display = 'flex';
        document.querySelector('.close').onclick = () => lightbox.style.display = 'none';
        lightbox.onclick = (e) => { if (e.target === lightbox) lightbox.style.display = 'none'; };
    }

    function toggleAllReviews() {
        const hidden = document.getElementById('hidden-reviews');
        const btn = event.target;
        if (hidden.style.display === 'none') {
            hidden.style.display = 'block';
            btn.textContent = '{{ gettext("hide_reviews", lang) }}';
        } else {
            hidden.style.display = 'none';
            btn.textContent = '{{ gettext("show_all_reviews", lang) }}';
        }
    }

    function showToast(message, isError = false) {
        const toastContainer = document.getElementById('toast-container') || document.body;
        const toastDiv = document.createElement('div');
        toastDiv.className = `toast align-items-center text-white ${isError ? 'bg-danger' : 'bg-success'} border-0 position-fixed top-0 start-50 translate-middle-x`;
        toastDiv.style.zIndex = 9999;
        toastDiv.innerHTML = `<div class="d-flex"><div class="toast-body">${message}</div><button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button></div>`;
        toastContainer.appendChild(toastDiv);
        new bootstrap.Toast(toastDiv).show();
        setTimeout(() => toastDiv.remove(), 5000);
    }

    // === ГЛАВНАЯ ЛОГИКА БРОНИРОВАНИЯ ===
    document.getElementById('booking-form')?.addEventListener('submit', async function(e) {
        e.preventDefault();

        const dateFrom = document.getElementById('date_from').value;
        const dateTo = document.getElementById('date_to').value;
        const firstName = document.getElementById('first_name').value.trim();
        const lastName = document.getElementById('last_name').value.trim();
        const phone = document.getElementById('phone').value.trim();
        const email = document.getElementById('guest_email').value.trim();

        if (!dateFrom || !dateTo || !firstName || !lastName || !phone || !email) {
            showToast('Заполните все поля', true);
            return;
        }

        const days = (new Date(dateTo) - new Date(dateFrom)) / (86400000);
        if (days <= 0) {
            showToast('Неверные даты', true);
            return;
        }

        const priceUsdPerNight = parseFloat(document.querySelector('.price-per-night').dataset.priceUsd);
        const totalUsd = (priceUsdPerNight * days).toFixed(2);

        const totalEl = document.getElementById('total-price');
        totalEl.innerText = `К оплате: ${totalUsd} USD`;
        totalEl.classList.remove('d-none');

        try {
            const response = await fetch('http://localhost:5002/create-payment', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    hotel_id: "{{ hotel._id }}",
                    hotel_name: "{{ hotel.name }}",
                    date_from: dateFrom,
                    date_to: dateTo,
                    total_amount_usd: parseFloat(totalUsd),
                    currency: "usd",
                    user_id: "{{ session['user_id'] }}",
                    guest: {
                        first_name: firstName,
                        last_name: lastName,
                        phone: phone,
                        email: email
                    },
                    success_url: window.location.origin + "/booking-success",
                    cancel_url: window.location.href
                })
            });

            const data = await response.json();

            if (data.payment_url) {
                window.location.href = data.payment_url +
                    `?hotel_name={{ hotel.name|urlencode }}` +
                    `&date_from=${dateFrom}&date_to=${dateTo}` +
                    `&lang={{ lang }}` +
                    `&guest_name=${encodeURIComponent(firstName + " " + lastName)}` +
                    `&guest_email=${encodeURIComponent(email)}` +
                    `&guest_phone=${encodeURIComponent(phone)}` +
                    `&total=${totalUsd}`;
            } else {
                showToast('Ошибка: ' + (data.error || 'неизвестно'), true);
            }
        } catch (err) {
            console.error(err);
            showToast('Не удалось связаться с платёжным сервисом. Убедитесь, что он запущен на порту 5002', true);
        }
    });

    // Старая валюта (не трогаем)
    document.addEventListener('DOMContentLoaded', function() {
        const currencyForms = document.querySelectorAll('.currency-form');
        const currencySymbols = { 'eur': 'EUR', 'uah': 'UAH', 'rub': 'RUB', 'usd': '$', 'mdl': 'L', 'ron': 'lei' };
        currencyForms.forEach(form => {
            form.addEventListener('submit', function(e) {
                e.preventDefault();
                const currency = this.querySelector('input[name="currency"]').value;
                const symbol = currencySymbols[currency];
                const priceUsd = parseFloat(document.querySelector('.price-per-night').getAttribute('data-price-usd'));

                fetch('/auth/set_currency', { method: 'POST', headers: { 'Content-Type': 'application/x-www-form-urlencoded' }, body: 'currency=' + encodeURIComponent(currency) })
                .then(r => r.json())
                .then(data => {
                    if (data.success) {
                        document.querySelector('.currency-icon').innerHTML = symbol;
                        fetch('/search/api/convert_price', { method: 'POST', headers: { 'Content-Type': 'application/x-www-form-urlencoded' }, body: `price_usd=${priceUsd}&currency=${encodeURIComponent(currency)}` })
                        .then(r => r.json())
                        .then(data => {
                            if (data.error) return showToast('Ошибка валюты', true);
                            const priceEl = document.querySelector('.price-per-night');
                            const prefix = priceEl.innerHTML.match(/^(.*?) \\d+\\.?\\d* \\S+/)[1];
                            priceEl.innerHTML = `${prefix} ${data.display_price} ${data.symbol}`;
                        });
                    }
                });
            });
        });
    });
</script>

<style>
    .lightbox { display: none; position: fixed; z-index: 9999; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.9); justify-content: center; align-items: center; flex-direction: column; }
    .lightbox-content { max-width: 90%; max-height: 90%; }
    .lightbox-main { position: relative; text-align: center; }
    #lightbox-img { max-width: 100%; max-height: 70vh; border-radius: 8px; }
    .nav-btn { position: absolute; top: 50%; transform: translateY(-50%); background: rgba(0,0,0,0.5); color: white; border: none; padding: 10px; font-size: 18px; cursor: pointer; }
    .prev { left: 10px; }
    .next { right: 10px; }
    .close { position: absolute; top: 15px; right: 25px; color: white; font-size: 40px; cursor: pointer; }
    .lightbox-thumbs { display: flex; justify-content: center; flex-wrap: wrap; margin-top: 10px; gap: 5px; max-height: 100px; overflow-y: auto; }
    .thumb { width: 60px; height: 60px; object-fit: cover; border: 2px solid transparent; cursor: pointer; border-radius: 4px; }
    .thumb.active { border-color: #007bff; }
</style>

{% endblock %}