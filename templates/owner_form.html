{% extends "base.html" %}

{% block title %}{{ gettext('owner_form_title', lang) }}{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-6">
        <h2>{{ gettext('owner_form_title', lang) }}</h2>
        <form method="POST" enctype="multipart/form-data" id="owner-form">
            <div class="mb-3">
                <label class="form-label">{{ gettext('hotel_name', lang) }}</label>
                <input type="text" class="form-control" name="name" required>
            </div>
            <div class="mb-3">
                <label class="form-label">{{ gettext('city', lang) }}</label>
                <input type="text" class="form-control" name="city" required>
            </div>
            <div class="mb-3">
                <label class="form-label">{{ gettext('price_usd', lang) }}</label>
                <input type="number" class="form-control" name="price_usd" step="0.01" required>
            </div>
            <div class="mb-3">
                <label class="form-label">{{ gettext('category', lang) }}</label>
                <select name="category" class="form-control" required>
                    <option value="1">1 {{ gettext('stars', lang) }}</option>
                    <option value="2">2 {{ gettext('stars', lang) }}</option>
                    <option value="3">3 {{ gettext('stars', lang) }}</option>
                    <option value="4">4 {{ gettext('stars', lang) }}</option>
                    <option value="5">5 {{ gettext('stars', lang) }}</option>
                </select>
            </div>
            <div class="mb-3">
                <label class="form-label">{{ gettext('description', lang) }}</label>
                <textarea class="form-control" name="description" rows="5" required></textarea>
            </div>
            <div class="mb-3">
                <label class="form-label">{{ gettext('photos', lang) }} ({{ gettext('max_10_photos', lang) }})</label>
                <input type="file" class="form-control" name="photos" multiple accept="image/*" id="photo-input">
                <small class="form-text text-muted">{{ gettext('max_10_photos_hint', lang) }}</small>
            </div>

            <!-- === АДРЕС === -->
            <div class="mb-3">
                <label class="form-label">{{ gettext('location_address', lang) }}</label>
                <input type="text" class="form-control" id="location-address" placeholder="{{ gettext('enter_address', lang) }}">
                <small class="form-text text-muted">{{ gettext('example_address', lang) }}: ул. Центральная 10, Кишинёв</small>
            </div>

            <!-- === КАРТА === -->
            <div class="mb-3">
                <label class="form-label">{{ gettext('select_location_on_map', lang) }}</label>
                <div id="map" style="height: 300px; border-radius: 8px; overflow: hidden;"></div>
                <small class="form-text text-muted">{{ gettext('click_on_map_hint', lang) }}</small>
            </div>

            <!-- Скрытые поля для координат -->
            <input type="hidden" name="latitude" id="latitude">
            <input type="hidden" name="longitude" id="longitude">

            <button type="submit" class="btn btn-primary">{{ gettext('submit_hotel', lang) }}</button>
        </form>
        <a href="{{ url_for('auth.profile') }}" class="btn btn-secondary mt-3">{{ gettext('back', lang) }}</a>
    </div>
</div>

<!-- Google Maps API -->
<!-- Google Maps API + двусторонняя синхронизация (адрес ↔ карта) -->
<script>
    let map, marker, geocoder, autocomplete;

    function initMap() {
        map = new google.maps.Map(document.getElementById("map"), {
            center: { lat: 47.0245, lng: 28.8323 },
            zoom: 12,
            mapTypeId: "roadmap",
        });

        geocoder = new google.maps.Geocoder();
        marker = null;

        // === Автокомплит адреса ===
        const input = document.getElementById("location-address");
        autocomplete = new google.maps.places.Autocomplete(input, {
            fields: ["formatted_address", "geometry"],
            strictBounds: false,
        });

        autocomplete.bindTo("bounds", map);

        autocomplete.addListener("place_changed", () => {
            const place = autocomplete.getPlace();
            if (!place.geometry || !place.geometry.location) return;

            map.setCenter(place.geometry.location);
            map.setZoom(17);

            placeMarker(place.geometry.location);
            document.getElementById("latitude").value = place.geometry.location.lat();
            document.getElementById("longitude").value = place.geometry.location.lng();

            // Заполняем адрес (человеческий)
            document.getElementById("location-address").value = place.formatted_address;
        });

        // === Клик по карте → обратный геокодинг (координаты → адрес) ===
        map.addListener("click", (e) => {
            const latLng = e.latLng;

            placeMarker(latLng);
            document.getElementById("latitude").value = latLng.lat();
            document.getElementById("longitude").value = latLng.lng();

            // Обратный геокодинг: координаты → адрес
            geocoder.geocode({ location: latLng }, (results, status) => {
                if (status === "OK" && results[0]) {
                    const address = results[0].formatted_address;
                    document.getElementById("location-address").value = address;
                } else {
                    document.getElementById("location-address").value = `Lat: ${latLng.lat().toFixed(6)}, Lng: ${latLng.lng().toFixed(6)}`;
                }
            });
        });
    }

    function placeMarker(latLng) {
        if (marker) marker.setMap(null);
        marker = new google.maps.Marker({
            position: latLng,
            map: map,
            draggable: true,
        });

        // При перетаскивании — обновляем адрес
        marker.addListener("dragend", () => {
            const pos = marker.getPosition();
            document.getElementById("latitude").value = pos.lat();
            document.getElementById("longitude").value = pos.lng();

            geocoder.geocode({ location: pos }, (results, status) => {
                if (status === "OK" && results[0]) {
                    document.getElementById("location-address").value = results[0].formatted_address;
                }
            });
        });
    }
</script>

<!-- Загрузка Google Maps API -->
<script async defer
    src="https://maps.googleapis.com/maps/api/js?key={{ config.GOOGLE_MAPS_API_KEY }}&libraries=places&callback=initMap">
</script>

<!-- Валидация формы -->
<script>
    document.getElementById('owner-form').addEventListener('submit', function(e) {
        const files = document.getElementById('photo-input').files;
        if (files.length > 10) {
            e.preventDefault();
            alert('{{ gettext("max_10_photos_alert", lang) }}');
            return;
        }

        const lat = document.getElementById('latitude').value;
        const lng = document.getElementById('longitude').value;
        if (!lat || !lng) {
            e.preventDefault();
            alert('{{ gettext("select_location_alert", lang) }}');
        }
    });
</script>
{% endblock %}