{% extends "base.html" %}

{% block title %}{{ gettext('moderator_panel_title', lang) }}{% endblock %}

{% block content %}
<h2>{{ gettext('moderator_panel_title', lang) }}</h2>
<h4>{{ gettext('pending_hotels', lang) }}</h4>
<ul class="list-group">
    {% for app in applications %}
        <li class="list-group-item">
            <strong>{{ app.hotel_data.get('name', 'Без названия') }}</strong> ({{ app.user_name }} - {{ app.user_email }})<br>
            <p><strong>{{ gettext('city', lang) }}:</strong> {{ app.hotel_data.get('city', 'Не указан') }}</p>
            <p><strong>{{ gettext('price_usd', lang) }}:</strong> {{ app.hotel_data.get('price_usd', 0) }} USD</p>
            <p><strong>{{ gettext('category', lang) }}:</strong> {{ app.hotel_data.get('category', 'Не указана') }} {{ gettext('stars', lang) }}</p>
            <p><strong>{{ gettext('description', lang) }}:</strong> {{ app.hotel_data.get('description', 'Без описания') }}</p>
            <div class="row">
                {% for photo in app.hotel_data.get('photos', []) %}
                    <div class="col-md-3">
                        <img src="data:image/jpeg;base64,{{ photo }}" class="img-fluid mb-2" alt="Hotel Photo" style="max-width: 150px;">
                    </div>
                {% endfor %}
            </div>
            <form class="mt-3" onsubmit="moderateApplication('{{ app._id }}', event)">
                <button type="submit" name="action" value="approve" class="btn btn-success btn-sm">{{ gettext('approve', lang) }}</button>
                <button type="button" class="btn btn-danger btn-sm" data-bs-toggle="modal" data-bs-target="#rejectModal{{ app._id }}">{{ gettext('reject', lang) }}</button>
            </form>
            <!-- Modal для причины отклонения -->
            <div class="modal fade" id="rejectModal{{ app._id }}" tabindex="-1" aria-labelledby="rejectModalLabel" aria-hidden="true">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title" id="rejectModalLabel">{{ gettext('rejection_reason', lang) }}</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            <textarea class="form-control" id="rejection_reason_{{ app._id }}" rows="4" placeholder="{{ gettext('rejection_reason', lang) }}" required></textarea>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Закрыть</button>
                            <button type="button" class="btn btn-danger" onclick="submitRejection('{{ app._id }}')">Подтвердить</button>
                        </div>
                    </div>
                </div>
            </div>
        </li>
    {% endfor %}
    {% if not applications %}
        <p>{{ gettext('no_pending_hotels', lang) }}</p>
    {% endif %}
</ul>

<script>
    function moderateApplication(applicationId, event) {
        event.preventDefault();
        const action = event.submitter.value;
        if (action === 'approve') {
            fetch('/moderator/moderate/' + applicationId, {
                method: 'POST',
                headers: {'Content-Type': 'application/x-www-form-urlencoded'},
                body: 'action=approve'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showToast(data.message);
                    setTimeout(() => location.reload(), 2000);
                } else {
                    showToast(data.error, true);
                }
            })
            .catch(error => {
                showToast(gettext('flash_error_prefix', '{{ lang }}') + 'Ошибка сервера!', true);
            });
        }
    }

    function submitRejection(applicationId) {
        const reason = document.getElementById('rejection_reason_' + applicationId).value;
        if (!reason.trim()) {
            showToast(gettext('flash_error_prefix', '{{ lang }}') + 'Укажите причину отклонения!', true);
            return;
        }
        fetch('/moderator/moderate/' + applicationId, {
            method: 'POST',
            headers: {'Content-Type': 'application/x-www-form-urlencoded'},
            body: 'action=reject&rejection_reason=' + encodeURIComponent(reason)
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showToast(data.message);
                setTimeout(() => location.reload(), 2000);
            } else {
                showToast(data.error, true);
            }
        })
        .catch(error => {
            showToast(gettext('flash_error_prefix', '{{ lang }}') + 'Ошибка сервера!', true);
        });
    }

    function showToast(message, isError = false) {
        const toastContainer = document.getElementById('toast-container');
        const toastDiv = document.createElement('div');
        toastDiv.className = `toast align-items-center text-white ${isError ? 'bg-danger' : 'bg-success'} border-0`;
        toastDiv.setAttribute('role', 'alert');
        toastDiv.setAttribute('aria-live', 'assertive');
        toastDiv.setAttribute('aria-atomic', 'true');
        toastDiv.innerHTML = `
            <div class="d-flex">
                <div class="toast-body">${message}</div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
        `;
        toastContainer.appendChild(toastDiv);
        const bsToast = new bootstrap.Toast(toastDiv);
        bsToast.show();
        setTimeout(() => bsToast.hide(), 3000);
    }
</script>
{% endblock %}