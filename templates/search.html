{% extends "base.html" %}

{% block title %}{{ gettext('search_title', lang) }}{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
    <div class="dropdown">
        <button class="btn btn-outline-primary dropdown-toggle" type="button" id="filterDropdown" data-bs-toggle="dropdown" aria-expanded="false">
            {{ gettext('search_btn', lang) }}
        </button>
        <div class="dropdown-menu p-3" aria-labelledby="filterDropdown" style="min-width: 300px;">
            <form id="filter-form">
                <div class="mb-2">
                    <label for="city" class="form-label">{{ gettext('search_city', lang) }}</label>
                    <select name="city" id="city" class="form-select">
                        <option value="all">{{ gettext('all_categories', lang) }}</option>
                        {% for city in cities %}
                            <option value="{{ city }}">{{ city }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="mb-2">
                    <label for="min_price" id="min_price_label" class="form-label">{{ gettext('min_price', lang) }} ({{ currency_symbol }})</label>
                    <input type="number" name="min_price" id="min_price" class="form-control" min="0" step="0.01" value="0">
                </div>
                <div class="mb-2">
                    <label for="max_price" id="max_price_label" class="form-label">{{ gettext('max_price', lang) }} ({{ currency_symbol }})</label>
                    <input type="number" name="max_price" id="max_price" class="form-control" min="0" step="0.01" value="999999">
                </div>
                <div class="mb-2">
                    <label for="category" class="form-label">{{ gettext('category', lang) }}</label>
                    <select name="category" id="category" class="form-select">
                        <option value="all">{{ gettext('all_categories', lang) }}</option>
                        {% for cat in categories %}
                            <option value="{{ cat }}">{{ cat }} {{ gettext('stars', lang) }}</option>
                        {% endfor %}
                    </select>
                </div>
                <button type="submit" class="btn btn-primary w-100">{{ gettext('search_btn', lang) }}</button>
                <button type="button" id="reset-filter" class="btn btn-secondary w-100 mt-2">{{ gettext('reset_filter', lang) }}</button>
            </form>
        </div>
    </div>
</div>

<div class="row" id="hotels-row"
     data-lang="{{ lang }}"
     data-currency-symbol="{{ currency_symbol }}"
     data-currency="{{ session.get('currency', 'usd') }}">
    {% for hotel in hotels %}
        <div class="col-md-4 mb-3">
            <div class="card h-100 hotel-card" data-hotel-id="{{ hotel._id }}" style="cursor: pointer;">
                <div class="card-body d-flex h-100">
                    <div class="card-img-container">
                        {% if hotel.photos and hotel.photos|length > 0 %}
                            <img src="data:image/jpeg;base64,{{ hotel.photos[0] }}"
                                 class="card-img-rect hotel-main-photo"
                                 data-photo-index="0"
                                 alt="{{ hotel.name }}">
                        {% else %}
                            <img src="https://via.placeholder.com/150x100?text={{ hotel.name }}"
                                 class="card-img-rect"
                                 alt="{{ hotel.name }}">
                        {% endif %}
                    </div>
                    <div class="card-content flex-grow-1 ms-3">
                        <h5 class="card-title">{{ hotel.name }}</h5>
                        <p class="card-text price-text"
                           data-price-usd="{{ hotel.price_usd }}">
                            {{ hotel.city }} | {{ hotel.category }} {{ gettext('stars', lang) }} |
                            {{ hotel.display_price }} {{ currency_symbol }} {{ gettext('per_night', lang) }}
                        </p>
                        <a href="{{ url_for('search.hotel_detail', hotel_id=hotel._id) }}"
                           class="btn btn-primary mt-auto"
                           onclick="event.stopPropagation();">
                            {{ gettext('details', lang) }}
                        </a>
                    </div>
                </div>
            </div>
        </div>
    {% endfor %}
</div>

<!-- ====================== ДАННЫЕ ДЛЯ JS ====================== -->
<script>
    // Передаём все отели клиенту в безопасном виде
    window.hotelsData = {{ hotels|tojson }};
</script>

<!-- ====================== LIGHTBOX ====================== -->
<div id="photo-lightbox" class="lightbox">
    <span class="close">&times;</span>
    <div class="lightbox-content">
        <div class="lightbox-main">
            <button class="nav-btn prev">&#10094;</button>
            <img id="lightbox-img" src="" alt="">
            <button class="nav-btn next">&#10095;</button>
        </div>
        <div id="lightbox-thumbs" class="lightbox-thumbs"></div>
    </div>
</div>

<script src="{{ url_for('static', filename='js/search.js') }}"></script>

<script>
    /* ---------- Открытие галереи по клику на карточку ---------- */
    document.querySelectorAll('.hotel-card').forEach(card => {
        card.addEventListener('click', function (e) {
            // Не открывать, если кликнули по кнопке "Details"
            if (e.target.closest('a')) return;

            const hotelId = this.dataset.hotelId;
            const hotel = window.hotelsData.find(h => h._id === hotelId);
            if (!hotel || !hotel.photos || hotel.photos.length === 0) return;

            const startIdx = 0; // всегда открываем с первой фотографии
            openLightbox(hotel.photos, startIdx);
        });
    });

    /* ---------- Функция галереи ---------- */
    function openLightbox(photos, startIndex) {
        const lightbox = document.getElementById('photo-lightbox');
        const mainImg = document.getElementById('lightbox-img');
        const thumbsContainer = document.getElementById('lightbox-thumbs');
        let currentIndex = startIndex;

        // ----- миниатюры -----
        thumbsContainer.innerHTML = '';
        photos.forEach((photo, i) => {
            const thumb = document.createElement('img');
            thumb.src = `data:image/jpeg;base64,${photo}`;
            thumb.className = 'thumb';
            if (i === currentIndex) thumb.classList.add('active');
            thumb.addEventListener('click', () => {
                currentIndex = i;
                updateMainImage();
            });
            thumbsContainer.appendChild(thumb);
        });

        function updateMainImage() {
            mainImg.src = `data:image/jpeg;base64,${photos[currentIndex]}`;
            document.querySelectorAll('.thumb').forEach((t, i) => {
                t.classList.toggle('active', i === currentIndex);
            });
        }

        updateMainImage();

        // ----- стрелки -----
        document.querySelector('.prev').onclick = () => {
            currentIndex = (currentIndex - 1 + photos.length) % photos.length;
            updateMainImage();
        };
        document.querySelector('.next').onclick = () => {
            currentIndex = (currentIndex + 1) % photos.length;
            updateMainImage();
        };

        // ----- скрыть/показать миниатюры -----
        let thumbsVisible = true;
        mainImg.onclick = () => {
            thumbsVisible = !thumbsVisible;
            thumbsContainer.style.display = thumbsVisible ? 'flex' : 'none';
        };

        // ----- закрытие -----
        lightbox.style.display = 'flex';
        document.querySelector('.close').onclick = closeLightbox;
        lightbox.onclick = (e) => {
            if (e.target === lightbox) closeLightbox();
        };

        function closeLightbox() {
            lightbox.style.display = 'none';
        }
    }
</script>
{% endblock %}